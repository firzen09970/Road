<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全台退伍旅費計算機 (368鄉鎮市區完整版)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f0f2f5; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h2 { color: #2c3e50; margin-top: 0; border-bottom: 4px solid #198754; padding-bottom: 10px; font-weight: 800; display: flex; align-items: center; }
        h2::before { content: '🪖'; margin-right: 10px; font-size: 1.2em; }

        .control-panel { background: #eef2f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; position: relative; z-index: 1000; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #495057; font-size: 1.1em; }
        
        .origin-box {
            background: #fff; border: 2px solid #6c757d; color: #495057;
            padding: 10px 15px; border-radius: 6px; font-weight: bold; font-size: 1.1em;
            display: flex; align-items: center;
        }
        .origin-icon { margin-right: 10px; font-size: 1.4em; }

        .ts-control { border-radius: 6px !important; padding: 12px !important; font-size: 16px !important; border: 1px solid #ced4da; }
        .btn-calc { 
            width: 100%; padding: 14px; background-color: #198754; color: white; 
            border: none; font-size: 18px; font-weight: bold; border-radius: 6px; 
            cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
        }
        .btn-calc:hover { background-color: #157347; transform: translateY(-1px); }
        
        .btn-gmaps {
            display: block; width: 100%; text-decoration: none; text-align: center;
            background-color: #4285F4; color: white; padding: 12px; border-radius: 6px;
            font-weight: bold; margin-top: 15px; box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
            transition: background 0.2s;
        }
        .btn-gmaps:hover { background-color: #3367D6; color: white; }

        #result-card {
            background-color: #fff; border: 1px solid #ddd;
            padding: 0; border-radius: 8px; margin-top: 20px; display: none;
            overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .result-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; }
        .result-body { padding: 15px; }
        .result-row { margin-bottom: 8px; font-size: 1.1em; line-height: 1.5; }
        .result-label { font-weight: bold; color: #555; display: inline-block; min-width: 80px; }
        .result-address { font-size: 0.95em; color: #666; display: block; margin-left: 0; margin-top: 2px;}
        .highlight-dist { color: #0d6efd; font-weight: 900; font-size: 1.2em; }

        .money-box {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #198754; color: #155724; padding: 15px;
            border-radius: 8px; margin-top: 15px; text-align: center;
        }
        .money-amount { font-size: 2.5em; font-weight: 900; line-height: 1.1; color: #dc3545; }
        .money-note { font-size: 0.85em; margin-top: 5px; color: #555; }

        #map { height: 450px; width: 100%; border-radius: 8px; margin-top: 20px; border: 1px solid #ddd; z-index: 1;}
        .note { font-size: 0.85em; color: #888; margin-top: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>退伍旅費計算機 (全台版)</h2>
    
    <div class="control-panel">
        <div class="form-group">
            <label>🏁 營區出發地 (固定)：</label>
            <div class="origin-box">
                <span class="origin-icon">📍</span> 
                842高雄市旗山區旗南三路234號
            </div>
        </div>
        
        <div class="form-group">
            <label for="district-select">🏠 戶籍地 (請搜尋區公所)：</label>
            <select id="district-select" placeholder="請輸入關鍵字 (如: 燕巢, 里港)..." autocomplete="off">
                <option value="">輸入關鍵字搜尋...</option>
            </select>
        </div>
        
        <button class="btn-calc" onclick="calculateRoute()">💵 計算路程與旅費</button>

        <div id="result-card">
            <div id="result-content"></div>
        </div>
        
        <div class="note">
            * 系統已內建全台 368 個鄉鎮市區公所資料。<br>
            * 若系統估算與實際有落差，請務必點擊藍色按鈕以 Google Maps 為準。
        </div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
    // --- 1. 全台完整資料庫 (格式: [區名, 地址, 緯度, 經度]) ---
    const rawData = {
        "基隆市": [
            ["中正區","基隆市中正區中正路236號",25.1436,121.7783],
            ["七堵區","基隆市七堵區光明路21號",25.0967,121.7139],
            ["暖暖區","基隆市暖暖區東勢街2號",25.1017,121.7347],
            ["仁愛區","基隆市仁愛區光一路28號",25.1287,121.7423],
            ["中山區","基隆市中山區文化路168號",25.1498,121.7308],
            ["安樂區","基隆市安樂區安樂路二段164號",25.1413,121.7078],
            ["信義區","基隆市信義區信二路179號",25.1257,121.7726]
        ],
        "臺北市": [
            ["松山區","臺北市松山區八德路四段692號",25.0503,121.5776],
            ["信義區","臺北市信義區福德街86號",25.0375,121.5802],
            ["大安區","臺北市大安區新生南路二段86號",25.0263,121.5364],
            ["中山區","臺北市中山區松江路367號",25.0634,121.5332],
            ["中正區","臺北市中正區忠孝東路一段108號",25.0440,121.5233],
            ["大同區","臺北市大同區昌吉街57號",25.0645,121.5134],
            ["萬華區","臺北市萬華區和平西路三段120號",25.0337,121.4965],
            ["文山區","臺北市文山區木柵路三段220號",24.9928,121.5701],
            ["南港區","臺北市南港區南港路一段360號",25.0543,121.6074],
            ["內湖區","臺北市內湖區民權東路六段99號",25.0689,121.5909],
            ["士林區","臺北市士林區中正路439號",25.0935,121.5255],
            ["北投區","臺北市北投區新市街30號",25.1320,121.4986]
        ],
        "新北市": [
            ["板橋區","新北市板橋區府中路30號",25.0094,121.4594],
            ["三重區","新北市三重區新北大道一段11號",25.0607,121.4883],
            ["中和區","新北市中和區景平路634-2號",25.0006,121.4998],
            ["永和區","新北市永和區竹林路200號",25.0115,121.5150],
            ["新莊區","新北市新莊區中平路133號",25.0450,121.4467],
            ["新店區","新北市新店區北新路一段86號",24.9681,121.5414],
            ["樹林區","新北市樹林區鎮前街93號",24.9922,121.4190],
            ["鶯歌區","新北市鶯歌區仁愛路55號",24.9547,121.3508],
            ["三峽區","新北市三峽區中山路17號",24.9344,121.3695],
            ["淡水區","新北市淡水區中山北路二段375號",25.1818,121.4397],
            ["汐止區","新北市汐止區新台五路一段268號",25.0664,121.6575],
            ["瑞芳區","新北市瑞芳區逢甲路82號",25.1084,121.8058],
            ["土城區","新北市土城區金城路一段101號",24.9723,121.4443],
            ["蘆洲區","新北市蘆洲區三民路95號",25.0864,121.4746],
            ["五股區","新北市五股區中興路四段50號",25.0841,121.4372],
            ["泰山區","新北市泰山區明志路一段322號",25.0592,121.4316],
            ["林口區","新北市林口區仁愛路一段378號",25.0782,121.3934],
            ["深坑區","新北市深坑區深坑街55號",24.9996,121.6158],
            ["石碇區","新北市石碇區潭邊里碇坪路一段26號",24.9912,121.6608],
            ["坪林區","新北市坪林區坪林街101號",24.9357,121.7121],
            ["三芝區","新北市三芝區中山路一段32號",25.2575,121.5002],
            ["石門區","新北市石門區中山路66號",25.2917,121.5678],
            ["八里區","新北市八里區中山路二段356號",25.1466,121.4011],
            ["平溪區","新北市平溪區平溪街45號",25.0253,121.7397],
            ["雙溪區","新北市雙溪區共和街6號",25.0375,121.8653],
            ["貢寮區","新北市貢寮區朝陽街54號",25.0227,121.9427],
            ["金山區","新北市金山區中正路167號",25.2218,121.6375],
            ["萬里區","新北市萬里區瑪鋉路123號",25.1789,121.6881],
            ["烏來區","新北市烏來區新烏路五段111號",24.8654,121.5516]
        ],
        "桃園市": [
            ["桃園區","桃園市桃園區縣府路7號",24.9936,121.3009],
            ["中壢區","桃園市中壢區環北路380號",24.9653,121.2255],
            ["大溪區","桃園市大溪區普濟路11號",24.8805,121.2868],
            ["楊梅區","桃園市楊梅區大成路2號",24.9148,121.1458],
            ["蘆竹區","桃園市蘆竹區南崁路150號",25.0503,121.2908],
            ["大園區","桃園市大園區中正西路12號",25.0645,121.1965],
            ["龜山區","桃園市龜山區中山街26號",24.9961,121.3516],
            ["八德區","桃園市八德區中山路47號",24.9287,121.2845],
            ["龍潭區","桃園市龍潭區中正路210號",24.8637,121.2155],
            ["平鎮區","桃園市平鎮區振興路5號",24.9436,121.2132],
            ["新屋區","桃園市新屋區中山路265號",24.9720,121.1044],
            ["觀音區","桃園市觀音區觀新路56號",25.0366,121.0805],
            ["復興區","桃園市復興區中正路20號",24.8236,121.3533]
        ],
        "新竹市": [
            ["東區","新竹市東區民族路40號",24.8073,120.9856],
            ["北區","新竹市北區國華街69號",24.8153,120.9664],
            ["香山區","新竹市香山區育德街188號",24.7709,120.9388]
        ],
        "新竹縣": [
            ["竹北市","新竹縣竹北市中正西路50號",24.8396,121.0097],
            ["竹東鎮","新竹縣竹東鎮東林路88號",24.7381,121.0924],
            ["新埔鎮","新竹縣新埔鎮中正路776號",24.8286,121.0728],
            ["關西鎮","新竹縣關西鎮正義路179號",24.7972,121.1764],
            ["湖口鄉","新竹縣湖口鄉中央街1號",24.9038,121.0435],
            ["新豐鄉","新竹縣新豐鄉新市路93號",24.8690,120.9958],
            ["芎林鄉","新竹縣芎林鄉文山路620號",24.7744,121.0809],
            ["橫山鄉","新竹縣橫山鄉新興街11號",24.7196,121.1160],
            ["北埔鄉","新竹縣北埔鄉中山路20號",24.6999,121.0583],
            ["寶山鄉","新竹縣寶山鄉雙園路二段321號",24.7607,121.0456],
            ["峨眉鄉","新竹縣峨眉鄉峨眉街8號",24.6865,121.0163],
            ["尖石鄉","新竹縣尖石鄉嘉樂村2鄰60號",24.7063,121.2043],
            ["五峰鄉","新竹縣五峰鄉大隘村6鄰95號",24.6291,121.1306]
        ],
        "苗栗縣": [
            ["苗栗市","苗栗縣苗栗市府前路76號",24.5694,120.8208],
            ["頭份市","苗栗縣頭份市中山路232號",24.6874,120.9135],
            ["苑裡鎮","苗栗縣苑裡鎮信義路1號",24.4423,120.6521],
            ["通霄鎮","苗栗縣通霄鎮中正路15號",24.4897,120.6787],
            ["竹南鎮","苗栗縣竹南鎮中正路112號",24.6855,120.8774],
            ["後龍鎮","苗栗縣後龍鎮中山路152號",24.6126,120.7864],
            ["卓蘭鎮","苗栗縣卓蘭鎮中山路127號",24.3129,120.8276],
            ["大湖鄉","苗栗縣大湖鄉中正路58號",24.4225,120.8647],
            ["公館鄉","苗栗縣公館鄉館中村宮前路1號",24.4996,120.8228],
            ["銅鑼鄉","苗栗縣銅鑼鄉銅鑼村永樂路20號",24.4862,120.7856],
            ["南庄鄉","苗栗縣南庄鄉中正路147號",24.5986,120.9996],
            ["頭屋鄉","苗栗縣頭屋鄉頭屋村中正街48號",24.5739,120.8491],
            ["三義鄉","苗栗縣三義鄉復興路30號",24.4116,120.7758],
            ["西湖鄉","苗栗縣西湖鄉龍洞村1鄰4號",24.5422,120.7490],
            ["造橋鄉","苗栗縣造橋鄉造橋村14鄰4號",24.6375,120.8631],
            ["三灣鄉","苗栗縣三灣鄉親民路9號",24.6543,120.9515],
            ["獅潭鄉","苗栗縣獅潭鄉新店村98號",24.5421,120.9205],
            ["泰安鄉","苗栗縣泰安鄉錦水村6鄰圓墩58號",24.4419,120.9100]
        ],
        "臺中市": [
            ["中區","臺中市中區成功路300號",24.1404,120.6817],
            ["東區","臺中市東區長福路245號",24.1352,120.6953],
            ["南區","臺中市南區工學路72號",24.1207,120.6565],
            ["西區","臺中市西區金山路11號",24.1432,120.6620],
            ["北區","臺中市北區永興街301號",24.1633,120.6826],
            ["西屯區","臺中市西屯區市政北二路386號",24.1593,120.6366],
            ["南屯區","臺中市南屯區永春東路679號",24.1384,120.6409],
            ["北屯區","臺中市北屯區崇德路三段10號",24.1804,120.6888],
            ["豐原區","臺中市豐原區市政路2號",24.2530,120.7203],
            ["東勢區","臺中市東勢區豐勢路518號",24.2588,120.8285],
            ["大甲區","臺中市大甲區民權路52號",24.3468,120.6226],
            ["清水區","臺中市清水區中社里鎮政路101號",24.2698,120.5733],
            ["沙鹿區","臺中市沙鹿區鎮政路8號",24.2341,120.5583],
            ["梧棲區","臺中市梧棲區中興路210號",24.2547,120.5317],
            ["后里區","臺中市后里區公安路8號",24.3059,120.7107],
            ["神岡區","臺中市神岡區神岡路30號",24.2580,120.6601],
            ["潭子區","臺中市潭子區豐興路一段512號",24.2081,120.7058],
            ["大雅區","臺中市大雅區雅環路二段301號",24.2287,120.6468],
            ["新社區","臺中市新社區興社街二段28之1號",24.2323,120.8066],
            ["石岡區","臺中市石岡區豐勢路1033號",24.2764,120.7738],
            ["外埔區","臺中市外埔區六分路390號",24.3298,120.6481],
            ["大安區","臺中市大安區中山南路356號",24.3499,120.5843],
            ["烏日區","臺中市烏日區新興路316號",24.1065,120.6231],
            ["大肚區","臺中市大肚區沙田路二段646號",24.1539,120.5401],
            ["龍井區","臺中市龍井區沙田路四段247號",24.2003,120.5447],
            ["霧峰區","臺中市霧峰區大同路20號",24.0621,120.7001],
            ["太平區","臺中市太平區中平路144號",24.1258,120.7161],
            ["大里區","臺中市大里區大新街36號",24.0995,120.6775],
            ["和平區","臺中市和平區南勢里東關路三段156號",24.1706,120.8756]
        ],
        "彰化縣": [
            ["彰化市","彰化縣彰化市光復路74號",24.0814,120.5385],
            ["員林市","彰化縣員林市三民街18號",23.9592,120.5701],
            ["鹿港鎮","彰化縣鹿港鎮民權路168號",24.0560,120.4350],
            ["和美鎮","彰化縣和美鎮鹿和路六段337號",24.1107,120.5002],
            ["線西鄉","彰化縣線西鄉和線路982號",24.1287,120.4674],
            ["伸港鄉","彰化縣伸港鄉中興路二段201號",24.1610,120.4862],
            ["福興鄉","彰化縣福興鄉彰鹿路7段495號",24.0435,120.4429],
            ["秀水鄉","彰化縣秀水鄉中山路290號",24.0354,120.5015],
            ["花壇鄉","彰化縣花壇鄉中正路72號",24.0270,120.5388],
            ["芬園鄉","彰化縣芬園鄉芬草路二段300號",24.0135,120.6272],
            ["溪湖鎮","彰化縣溪湖鎮青雅路58號",23.9609,120.4789],
            ["田中鎮","彰化縣田中鎮斗中路一段198號",23.8617,120.5898],
            ["大村鄉","彰化縣大村鄉中正西路338號",23.9928,120.5448],
            ["埔鹽鄉","彰化縣埔鹽鄉彰水路二段247號",24.0016,120.4632],
            ["埔心鄉","彰化縣埔心鄉員鹿路二段334號",23.9525,120.5435],
            ["永靖鄉","彰化縣永靖鄉永坡路25號",23.9248,120.5471],
            ["社頭鄉","彰化縣社頭鄉社斗路一段295號",23.8967,120.5828],
            ["二水鄉","彰化縣二水鄉民生路366號",23.8150,120.6178],
            ["北斗鎮","彰化縣北斗鎮公所街2號",23.8741,120.5262],
            ["二林鎮","彰化縣二林鎮斗苑路四段636號",23.8997,120.3732],
            ["田尾鄉","彰化縣田尾鄉公所路201號",23.8920,120.5309],
            ["埤頭鄉","彰化縣埤頭鄉斗苑路西段138號",23.8916,120.4608],
            ["芳苑鄉","彰化縣芳苑鄉斗苑路芳苑段202號",23.9261,120.3204],
            ["大城鄉","彰化縣大城鄉中平路163號",23.8540,120.3209],
            ["竹塘鄉","彰化縣竹塘鄉竹林路一段305號",23.8613,120.4239],
            ["溪州鄉","彰化縣溪州鄉中山路三段270號",23.8529,120.5042]
        ],
        "南投縣": [
            ["南投市","南投縣南投市玉井街5號",23.9103,120.6860],
            ["埔里鎮","南投縣埔里鎮中山路二段239號",23.9667,120.9686],
            ["草屯鎮","南投縣草屯鎮草溪路979號",23.9749,120.6850],
            ["竹山鎮","南投縣竹山鎮公所路100號",23.7571,120.6713],
            ["集集鎮","南投縣集集鎮民生路61號",23.8296,120.7846],
            ["名間鄉","南投縣名間鄉中正村彰南路26號",23.8398,120.7029],
            ["鹿谷鄉","南投縣鹿谷鄉中正路二段73號",23.7444,120.7523],
            ["中寮鄉","南投縣中寮鄉永平路270號",23.8797,120.7818],
            ["魚池鄉","南投縣魚池鄉秀水巷2-1號",23.8969,120.9366],
            ["國姓鄉","南投縣國姓鄉國姓路267號",24.0416,120.8560],
            ["水里鄉","南投縣水里鄉民生路112號",23.8124,120.8521],
            ["信義鄉","南投縣信義鄉明德村玉山路47號",23.6938,120.8659],
            ["仁愛鄉","南投縣仁愛鄉大同村仁和路29號",24.0227,121.1293]
        ],
        "雲林縣": [
            ["斗六市","雲林縣斗六市府文路38號",23.7093,120.5434],
            ["斗南鎮","雲林縣斗南鎮文昌路158號",23.6760,120.4795],
            ["虎尾鎮","雲林縣虎尾鎮行政路6號",23.7082,120.4338],
            ["西螺鎮","雲林縣西螺鎮延平路389號",23.7963,120.4627],
            ["土庫鎮","雲林縣土庫鎮中正路175號",23.6766,120.3929],
            ["北港鎮","雲林縣北港鎮民主路1號",23.5756,120.3060],
            ["古坑鄉","雲林縣古坑鄉中山路50號",23.6454,120.5599],
            ["大埤鄉","雲林縣大埤鄉中山路10號",23.6455,120.4307],
            ["莿桐鄉","雲林縣莿桐鄉中山路114號",23.7604,120.5218],
            ["林內鄉","雲林縣林內鄉林中路12號",23.7592,120.6133],
            ["二崙鄉","雲林縣二崙鄉中正路59號",23.7709,120.4150],
            ["崙背鄉","雲林縣崙背鄉南陽路42號",23.7609,120.3541],
            ["麥寮鄉","雲林縣麥寮鄉中興路108號",23.7540,120.2529],
            ["東勢鄉","雲林縣東勢鄉所前街3號",23.6751,120.2536],
            ["褒忠鄉","雲林縣褒忠鄉中正路326號",23.6946,120.3106],
            ["臺西鄉","雲林縣臺西鄉中山路195號",23.7023,120.1989],
            ["元長鄉","雲林縣元長鄉長南路127號",23.6493,120.3129],
            ["四湖鄉","雲林縣四湖鄉中山路68號",23.6375,120.2263],
            ["口湖鄉","雲林縣口湖鄉中正路一段118號",23.5828,120.1852],
            ["水林鄉","雲林縣水林鄉水林路12號",23.5739,120.2461]
        ],
        "嘉義市": [
            ["東區","嘉義市東區吳鳳北路184號",23.4862,120.4633],
            ["西區","嘉義市西區錦州二街28號",23.4777,120.4334]
        ],
        "嘉義縣": [
            ["太保市","嘉義縣太保市太保里36號",23.4593,120.3323],
            ["朴子市","嘉義縣朴子市光復路34號",23.4651,120.2472],
            ["布袋鎮","嘉義縣布袋鎮興中里自由路1號",23.3780,120.1654],
            ["大林鎮","嘉義縣大林鎮中正路234號",23.6019,120.4554],
            ["民雄鄉","嘉義縣民雄鄉文化路7號",23.5515,120.4285],
            ["溪口鄉","嘉義縣溪口鄉中山路127號",23.6009,120.3934],
            ["新港鄉","嘉義縣新港鄉中山路155號",23.5539,120.3477],
            ["六腳鄉","嘉義縣六腳鄉蒜頭村73號",23.5100,120.2922],
            ["東石鄉","嘉義縣東石鄉東石村3號",23.4563,120.1558],
            ["義竹鄉","嘉義縣義竹鄉六桂村245號",23.3421,120.2464],
            ["鹿草鄉","嘉義縣鹿草鄉西井村287號",23.4116,120.3100],
            ["水上鄉","嘉義縣水上鄉正義路141號",23.4277,120.4074],
            ["中埔鄉","嘉義縣中埔鄉中埔村128號",23.4243,120.5055],
            ["竹崎鄉","嘉義縣竹崎鄉中山路59號",23.5199,120.5513],
            ["梅山鄉","嘉義縣梅山鄉中山路282號",23.5826,120.5601],
            ["番路鄉","嘉義縣番路鄉下坑村菜公店101號",23.4652,120.5540],
            ["大埔鄉","嘉義縣大埔鄉大埔村54號",23.2982,120.5947],
            ["阿里山鄉","嘉義縣阿里山鄉樂野村2鄰69號",23.4566,120.7165]
        ],
        "臺南市": [
            ["永康區","臺南市永康區中山南路655號",23.0261,120.2563],
            ["中西區","臺南市中西區開山路1號",22.9893,120.2086],
            ["東區","臺南市東區崇學路100號",22.9806,120.2244],
            ["南區","臺南市南區明興路2號",22.9613,120.1917],
            ["北區","臺南市北區成功路238巷7號",22.9997,120.2016],
            ["安平區","臺南市安平區育平路316號",22.9934,120.1706],
            ["安南區","臺南市安南區安中路二段308號",23.0483,120.1834],
            ["歸仁區","臺南市歸仁區中正南路一段1213號",22.9680,120.2942],
            ["新化區","臺南市新化區中山路130號",23.0371,120.3060],
            ["仁德區","臺南市仁德區中正路三段5號",22.9719,120.2505],
            ["關廟區","臺南市關廟區中正路998號",22.9616,120.3275],
            ["官田區","臺南市官田區中山路一段132號",23.1843,120.3117],
            ["麻豆區","臺南市麻豆區忠孝路250號",23.1860,120.2476],
            ["佳里區","臺南市佳里區忠孝路5號",23.1673,120.1773],
            ["新營區","臺南市新營區中正路30號",23.3073,120.3150],
            ["善化區","臺南市善化區建國路190號",23.1323,120.2965],
            ["新市區","臺南市新市區中興街12號",23.0788,120.2952],
            ["左鎮區","臺南市左鎮區中正里171號",23.0560,120.3942],
            ["玉井區","臺南市玉井區中正路27號",23.1239,120.4611],
            ["楠西區","臺南市楠西區中興路107號",23.1741,120.4851],
            ["南化區","臺南市南化區南化里230號",23.0440,120.4784],
            ["龍崎區","臺南市龍崎區新市子161號",22.9647,120.3606],
            ["西港區","臺南市西港區文化路1號",23.1221,120.2031],
            ["七股區","臺南市七股區大埕里377號",23.1408,120.1384],
            ["將軍區","臺南市將軍區忠興里190號",23.1994,120.1554],
            ["學甲區","臺南市學甲區華宗路313號",23.2307,120.1818],
            ["北門區","臺南市北門區北門里舊埕108號",23.2687,120.1252],
            ["後壁區","臺南市後壁區後壁里129號",23.3670,120.3608],
            ["白河區","臺南市白河區永安里三民路381號",23.3510,120.4150],
            ["東山區","臺南市東山區東山里225號",23.3243,120.4034],
            ["六甲區","臺南市六甲區中山路202號",23.2282,120.3475],
            ["下營區","臺南市下營區中山路二段128號",23.2359,120.2646],
            ["柳營區","臺南市柳營區柳營路二段156號",23.2789,120.3112],
            ["鹽水區","臺南市鹽水區中山路47號",23.3196,120.2657],
            ["大內區","臺南市大內區大內里1號",23.1194,120.3541],
            ["山上區","臺南市山上區山上里110號",23.1042,120.3533],
            ["安定區","臺南市安定區安定里59號",23.1221,120.2372]
        ],
        "高雄市": [
            ["旗山區","高雄市旗山區延平一路499號",22.8885,120.4826],
            ["燕巢區","高雄市燕巢區中安路1號",22.7933,120.3621],
            ["美濃區","高雄市美濃區美中路260號",22.9156,120.5428],
            ["鳳山區","高雄市鳳山區經武路30號",22.6253,120.3661],
            ["苓雅區","高雄市苓雅區民權一路85號",22.6224,120.3118],
            ["三民區","高雄市三民區哈爾濱街215號",22.6433,120.3155],
            ["左營區","高雄市左營區左營大路479號",22.6896,120.3094],
            ["楠梓區","高雄市楠梓區楠梓新路264號",22.7291,120.3270],
            ["小港區","高雄市小港區小港路158號",22.5651,120.3534],
            ["鼓山區","高雄市鼓山區鼓山二路166號",22.6264,120.2764],
            ["新興區","高雄市新興區中正三路34號",22.6288,120.3053],
            ["前金區","高雄市前金區自強二路1號",22.6277,120.2941],
            ["鹽埕區","高雄市鹽埕區大仁路79號",22.6247,120.2863],
            ["前鎮區","高雄市前鎮區康定路151號",22.5864,120.3184],
            ["旗津區","高雄市旗津區旗津三路2號",22.5899,120.2786],
            ["大寮區","高雄市大寮區鳳林三路375號",22.6053,120.3965],
            ["林園區","高雄市林園區王公路1號",22.5050,120.3957],
            ["仁武區","高雄市仁武區中正路135號",22.6983,120.3475],
            ["岡山區","高雄市岡山區岡山路343號",22.7960,120.2960],
            ["路竹區","高雄市路竹區國昌路76號",22.8550,120.2618],
            ["大社區","高雄市大社區三民路369號",22.7303,120.3467],
            ["鳥松區","高雄市鳥松區中正路98號",22.6593,120.3655],
            ["大樹區","高雄市大樹區中興街1號",22.6934,120.4332],
            ["六龜區","高雄市六龜區民治路18號",22.9979,120.6329],
            ["內門區","高雄市內門區觀亭村中正路156號",22.9416,120.4605],
            ["杉林區","高雄市杉林區山仙路26號",22.9723,120.5348],
            ["甲仙區","高雄市甲仙區中正路26號",23.0827,120.5906],
            ["桃源區","高雄市桃源區桃源里南進巷1號",23.1601,120.7099],
            ["那瑪夏區","高雄市那瑪夏區達卡努瓦里大光巷230號",23.2307,120.6936],
            ["茂林區","高雄市茂林區茂林里11號",22.8937,120.6582],
            ["茄萣區","高雄市茄萣區濱海路四段27號",22.9064,120.1824],
            ["阿蓮區","高雄市阿蓮區民生路94號",22.8837,120.3273],
            ["田寮區","高雄市田寮區崗安路71號",22.8797,120.3607],
            ["梓官區","高雄市梓官區梓官路258號",22.7610,120.2673],
            ["彌陀區","高雄市彌陀區中華路4號",22.7831,120.2472],
            ["永安區","高雄市永安區永安路28號",22.8193,120.2263],
            ["湖內區","高雄市湖內區中山路二段170號",22.9038,120.2195],
            ["橋頭區","高雄市橋頭區隆豐路1號",22.7575,120.3056]
        ],
        "屏東縣": [
            ["屏東市","屏東縣屏東市台糖街61號",22.6771,120.5042],
            ["潮州鎮","屏東縣潮州鎮中山路38號",22.5505,120.5422],
            ["東港鎮","屏東縣東港鎮新勝街101號",22.4678,120.4529],
            ["恆春鎮","屏東縣恆春鎮天文路1號",22.0028,120.7454],
            ["里港鄉","屏東縣里港鄉和平路13號",22.7792,120.4947],
            ["萬丹鄉","屏東縣萬丹鄉和平西路151號",22.5898,120.4845],
            ["長治鄉","屏東縣長治鄉潭頭路1號",22.6772,120.5284],
            ["麟洛鄉","屏東縣麟洛鄉中山路158號",22.6515,120.5255],
            ["九如鄉","屏東縣九如鄉九如路二段400號",22.7397,120.4902],
            ["鹽埔鄉","屏東縣鹽埔鄉勝利路32號",22.7554,120.5732],
            ["高樹鄉","屏東縣高樹鄉興中路329號",22.8247,120.5997],
            ["萬巒鄉","屏東縣萬巒鄉中正路36號",22.5718,120.5677],
            ["內埔鄉","屏東縣內埔鄉廣濟路26號",22.6151,120.5666],
            ["竹田鄉","屏東縣竹田鄉中正路123號",22.5855,120.5422],
            ["新埤鄉","屏東縣新埤鄉中正路42號",22.4700,120.5492],
            ["枋寮鄉","屏東縣枋寮鄉德興路36號",22.3656,120.5947],
            ["新園鄉","屏東縣新園鄉仙吉路142號",22.5406,120.4619],
            ["崁頂鄉","屏東縣崁頂鄉中正路230號",22.5126,120.4879],
            ["林邊鄉","屏東縣林邊鄉和平路53號",22.4339,120.5117],
            ["南州鄉","屏東縣南州鄉三民路1號",22.4897,120.5098],
            ["佳冬鄉","屏東縣佳冬鄉佳和路70號",22.4170,120.5515],
            ["琉球鄉","屏東縣琉球鄉中正路110號",22.3486,120.3670],
            ["車城鄉","屏東縣車城鄉中山路53號",22.0722,120.7107],
            ["滿州鄉","屏東縣滿州鄉中山路45號",22.0208,120.8384],
            ["枋山鄉","屏東縣枋山鄉枋山村116號",22.2604,120.6512],
            ["三地門鄉","屏東縣三地門鄉中正路二段100號",22.7115,120.6543],
            ["霧臺鄉","屏東縣霧臺鄉神山巷73號",22.7483,120.7303],
            ["瑪家鄉","屏東縣瑪家鄉風景巷85號",22.6439,120.6432],
            ["泰武鄉","屏東縣泰武鄉佳平巷1號",22.5930,120.6300],
            ["來義鄉","屏東縣來義鄉中正路二段96號",22.5259,120.6339],
            ["春日鄉","屏東縣春日鄉春日路322號",22.3708,120.6288],
            ["獅子鄉","屏東縣獅子鄉楓林二巷26號",22.2019,120.7058],
            ["牡丹鄉","屏東縣牡丹鄉石門路26號",22.1259,120.8229]
        ],
        "宜蘭縣": [
            ["宜蘭市","宜蘭縣宜蘭市中山路二段432號",24.7570,121.7530],
            ["羅東鎮","宜蘭縣羅東鎮中興路3號",24.6750,121.7669],
            ["蘇澳鎮","宜蘭縣蘇澳鎮蘇港路215號",24.5946,121.8496],
            ["頭城鎮","宜蘭縣頭城鎮新建路130號",24.8582,121.8233],
            ["礁溪鄉","宜蘭縣礁溪鄉中山路二段3號",24.8234,121.7702],
            ["壯圍鄉","宜蘭縣壯圍鄉壯五路51號",24.7449,121.7951],
            ["員山鄉","宜蘭縣員山鄉員山路一段322號",24.7423,121.7214],
            ["冬山鄉","宜蘭縣冬山鄉冬山路100號",24.6346,121.7925],
            ["五結鄉","宜蘭縣五結鄉五結路二段343號",24.6931,121.7972],
            ["三星鄉","宜蘭縣三星鄉集慶村集義路168號",24.6657,121.6496],
            ["大同鄉","宜蘭縣大同鄉崙埤村朝陽38號",24.6760,121.6062],
            ["南澳鄉","宜蘭縣南澳鄉南澳村蘇花路二段381號",24.4646,121.7989]
        ],
        "花蓮縣": [
            ["花蓮市","花蓮縣花蓮市林森路252號",23.9772,121.6046],
            ["鳳林鎮","花蓮縣鳳林鎮光華路124號",23.7446,121.4504],
            ["玉里鎮","花蓮縣玉里鎮中正路148號",23.3364,121.3163],
            ["新城鄉","花蓮縣新城鄉光復路570號",24.0298,121.6133],
            ["吉安鄉","花蓮縣吉安鄉吉安村吉安路二段65號",23.9606,121.5684],
            ["壽豐鄉","花蓮縣壽豐鄉壽豐村壽山路26號",23.8710,121.5085],
            ["光復鄉","花蓮縣光復鄉中華路257號",23.6635,121.4234],
            ["豐濱鄉","花蓮縣豐濱鄉光豐路32號",23.5979,121.5253],
            ["瑞穗鄉","花蓮縣瑞穗鄉成功南路19號",23.4975,121.3780],
            ["富里鄉","花蓮縣富里鄉中山路376號",23.2452,121.2494],
            ["秀林鄉","花蓮縣秀林鄉秀林村62號",24.1166,121.6190],
            ["萬榮鄉","花蓮縣萬榮鄉萬榮村1號",23.7145,121.4080],
            ["卓溪鄉","花蓮縣卓溪鄉卓溪村中正67號",23.3468,121.1687]
        ],
        "臺東縣": [
            ["臺東市","臺東縣臺東市博愛路365號",22.7561,121.1506],
            ["成功鎮","臺東縣成功鎮中山路176號",23.1009,121.3725],
            ["關山鎮","臺東縣關山鎮中山路54號",23.0474,121.1619],
            ["卑南鄉","臺東縣卑南鄉太平村和平路111號",22.7844,121.0833],
            ["鹿野鄉","臺東縣鹿野鄉瑞隆村瑞景路一段21號",22.9142,121.1540],
            ["池上鄉","臺東縣池上鄉中山路101號",23.1221,121.2155],
            ["東河鄉","臺東縣東河鄉東河村南東河311號",22.9691,121.2995],
            ["長濱鄉","臺東縣長濱鄉長濱村58號",23.3150,121.4515],
            ["太麻里鄉","臺東縣太麻里鄉泰和村太麻里街285號",22.6158,121.0076],
            ["大武鄉","臺東縣大武鄉尚武村政通三街5號",22.3559,120.8988],
            ["綠島鄉","臺東縣綠島鄉中寮村58號",22.6657,121.4851],
            ["海端鄉","臺東縣海端鄉海端村4鄰山界43號",23.1072,121.1765],
            ["延平鄉","臺東縣延平鄉桃源村1鄰昇平路1號",22.9037,121.0827],
            ["金峰鄉","臺東縣金峰鄉嘉蘭村4鄰165號",22.5956,120.9701],
            ["達仁鄉","臺東縣達仁鄉安朔村復興路14號",22.2941,120.8872],
            ["蘭嶼鄉","臺東縣蘭嶼鄉紅頭村31號",22.0567,121.5583]
        ],
        "澎湖縣": [
            ["馬公市","澎湖縣馬公市永福街30號",23.5658,119.5692],
            ["湖西鄉","澎湖縣湖西鄉湖西村43之11號",23.5852,119.6481],
            ["白沙鄉","澎湖縣白沙鄉赤崁村366號",23.6644,119.5937],
            ["西嶼鄉","澎湖縣西嶼鄉池東村139號",23.6015,119.5165],
            ["望安鄉","澎湖縣望安鄉東安村73-1號",23.3712,119.5028],
            ["七美鄉","澎湖縣七美鄉中和村4鄰16-3號",23.2078,119.4267]
        ],
        "金門縣": [
            ["金城鎮","金門縣金城鎮民生路2號",24.4168,118.3168],
            ["金沙鎮","金門縣金沙鎮環島東路1段112號2樓",24.4920,118.4116],
            ["金湖鎮","金門縣金湖鎮林森路2號",24.4385,118.4162],
            ["金寧鄉","金門縣金寧鄉仁愛新村1號",24.4578,118.3248],
            ["烈嶼鄉","金門縣烈嶼鄉西路60號",24.4300,118.2435],
            ["烏坵鄉","金門縣烏坵鄉大坵村1號",24.9917,119.4447]
        ],
        "連江縣": [
            ["南竿鄉","連江縣南竿鄉清水村131號",26.1557,119.9328],
            ["北竿鄉","連江縣北竿鄉塘岐村261號",26.2234,119.9919],
            ["莒光鄉","連江縣莒光鄉青帆村74之2號",25.9680,119.9333],
            ["東引鄉","連江縣東引鄉樂華村161號",26.3662,120.4936]
        ]
    };

    // --- 2. 程式邏輯 ---
    const originAddr = "842高雄市旗山區旗南三路234號";
    const startLat = 22.8028; 
    const startLng = 120.4566;
    
    const map = L.map('map').setView([23.5, 121], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const startMarker = L.marker([startLat, startLng], {icon: L.divIcon({className: 'custom-icon', html: '🚩', iconSize: [30, 30]})}).addTo(map)
        .bindPopup(`<b>🚩 營區 (出發地)</b><br>${originAddr}`).openPopup();

    let routeLayer = null;
    let endMarker = null;

    // --- 3. 填充選單 ---
    const select = document.getElementById('district-select');
    
    // 遍歷所有縣市
    for (const [city, districts] of Object.entries(rawData)) {
        const group = document.createElement('optgroup');
        group.label = city;
        
        // districts 是陣列: [區名, 地址, 緯度, 經度]
        districts.forEach(d => {
            const [distName, addr, lat, lng] = d;
            const option = document.createElement('option');
            
            // 將資料打包進 value
            option.value = JSON.stringify({
                lat: lat, 
                lng: lng, 
                addr: addr, 
                name: city + distName
            });
            option.text = `${city}${distName}`;
            group.appendChild(option);
        });
        select.appendChild(group);
    }

    let tomSelectInstance = new TomSelect('#district-select', {
        create: false,
        sortField: { field: "text", direction: "asc" },
        placeholder: "輸入戶籍地區 (例如: 燕巢, 安南)..."
    });

    // --- 4. 計算路徑與 Google Link 產生 ---
    async function calculateRoute() {
        const resultCard = document.getElementById('result-card');
        const resultContent = document.getElementById('result-content');
        const selectedValue = select.value;

        if (!selectedValue) {
            alert("請先輸入您的戶籍地 (區公所)！");
            tomSelectInstance.focus();
            return;
        }

        const destData = JSON.parse(selectedValue);
        const endLat = destData.lat;
        const endLng = destData.lng;
        
        resultCard.style.display = 'block';
        resultContent.innerHTML = "<div style='padding:15px; text-align:center;'>⏳ 正在計算距離與金額...</div>";

        // OSRM API (用於網頁快速預覽)
        const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;

        // 產生 Google Maps 連結
        // 確保中文地址不會亂碼
        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(originAddr)}&destination=${encodeURIComponent(destData.addr)}&travelmode=driving`;

        try {
            const response = await fetch(osrmUrl);
            const data = await response.json();

            if (data.code !== 'Ok') {
                // 如果 OSRM 找不到路 (例如金門/澎湖)，顯示提示但允許開 Google Maps
                resultContent.innerHTML = `
                    <div style='padding:15px;'>
                        <div class="result-header">
                            <div class="result-row"><span class="result-label">目的地：</span><b>${destData.name}</b></div>
                            <div class="result-row"><span class="result-label">地址：</span><span class="result-address">${destData.addr}</span></div>
                        </div>
                        <div style="padding:15px; color:#d63384;">
                            ⚠️ 此地點可能為離島或無法規劃開車路徑。請直接使用下方按鈕確認。
                        </div>
                         <a href="${googleMapsUrl}" target="_blank" class="btn-gmaps">
                            🗺️ 開啟 Google Maps 驗證
                        </a>
                    </div>`;
                return;
            }

            const route = data.routes[0];
            const distanceKm = (route.distance / 1000).toFixed(1); // 公里數
            
            // 旅費計算
            let money = 0;
            let ruleDesc = "";
            
            if (parseFloat(distanceKm) >= 60) {
                money = 600;
                ruleDesc = "(系統估算 ≥ 60km)";
            } else {
                money = 200;
                ruleDesc = "(系統估算 < 60km)";
            }

            // 顯示結果
            resultContent.innerHTML = `
                <div class="result-header">
                    <div class="result-row"><span class="result-label">目的地：</span><b>${destData.name}</b></div>
                    <div class="result-row"><span class="result-label">地址：</span><span class="result-address">${destData.addr}</span></div>
                </div>
                <div class="result-body">
                    <div class="result-row"><span class="result-label">預估距離：</span><span class="highlight-dist">${distanceKm}</span> 公里</div>
                    
                    <div class="money-box">
                        <div class="money-title">💰 系統預算金額</div>
                        <div class="money-amount">NT$ ${money}</div>
                        <div class="money-note">${ruleDesc}</div>
                    </div>

                    <a href="${googleMapsUrl}" target="_blank" class="btn-gmaps">
                        🗺️ 開啟 Google Maps 驗證 (供截圖核銷)
                    </a>
                </div>
            `;

            if (routeLayer) map.removeLayer(routeLayer);
            if (endMarker) map.removeLayer(endMarker);

            routeLayer = L.geoJSON(route.geometry, {
                style: { color: '#198754', weight: 6, opacity: 0.8 }
            }).addTo(map);

            endMarker = L.marker([endLat, endLng], {icon: L.divIcon({className: 'custom-icon', html: '🏠', iconSize: [30, 30]})}).addTo(map)
                .bindPopup(`<b>🏁 戶籍地</b><br>${destData.addr}`).openPopup();

            map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

        } catch (error) {
            console.error(error);
            resultContent.innerHTML = "<div style='padding:15px; color:red;'>⚠️ 連線錯誤，請檢查網路狀態。</div>";
        }
    }
</script>

</body>
</html>
